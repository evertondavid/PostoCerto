# üß† PostoCerto - Arquivo de Mem√≥ria e Regras do Projeto

> **IMPORTANTE**: Este arquivo deve ser consultado SEMPRE antes de fornecer qualquer sugest√£o, comando, orienta√ß√£o ou implementa√ß√£o de c√≥digo.

---

## ‚ö†Ô∏è REGRAS CR√çTICAS DE INTERA√á√ÉO

### üêå **PASSO A PASSO OBRIGAT√ìRIO**
- **NUNCA dar m√∫ltiplos passos de uma vez**
- **AGUARDAR confirma√ß√£o "OK" do usu√°rio** antes de avan√ßar
- **UM comando por vez, UM arquivo por vez, UM teste por vez**
- **N√ÉO assumir que o passo foi conclu√≠do** sem confirma√ß√£o expl√≠cita
- Sempre perguntar: "Execute esse comando e me avise quando der OK ‚úÖ"
- N√£o dar longos tutoriais - focar no passo imediato

### üìù **Fluxo de Orienta√ß√£o TDD (Passo a Passo)**
1. Orientar cria√ß√£o de **UM teste** espec√≠fico
2. ‚è∏Ô∏è **Aguardar "OK"**
3. Orientar implementa√ß√£o m√≠nima para passar naquele teste
4. ‚è∏Ô∏è **Aguardar "OK"**
5. Orientar execu√ß√£o de `dotnet test`
6. ‚è∏Ô∏è **Aguardar resultado**
7. S√≥ ent√£o avan√ßar para pr√≥ximo teste/comportamento

---

## üìå FASE ATUAL DO PROJETO

### ‚úÖ **FASE 01: Domain Layer + Tests (TDD) - Em andamento**
- **Objetivo**: Criar Entidades de Dom√≠nio com Clean Architecture, DDD e **Test-Driven Development (TDD)**
- **Escopo**: Implementar camada `Domain` + `Domain.Tests` de cada microservi√ßo
- **Metodologia**: **TDD obrigat√≥rio** (Red ‚Üí Green ‚Üí Refactor)
- **N√ÉO implementar ainda**: Application, Infrastructure, API, Frontend, Infraestrutura

---

## üèóÔ∏è ARQUITETURA E PRINC√çPIOS

### Clean Architecture (Camadas)
```
Domain + Tests (Fase 01 - ATUAL) ‚Üê TDD
   ‚Üë
Application + Tests (Fase 02 - FUTURO)
   ‚Üë
Infrastructure + Tests (Fase 03 - FUTURO)
   ‚Üë
Api + Integration Tests (Fase 04 - FUTURO)
```

### Test-Driven Development (TDD) - OBRIGAT√ìRIO NA FASE 01
```
üî¥ RED: Escrever teste que FALHA
   ‚Üì
üü¢ GREEN: Implementar c√≥digo m√≠nimo para PASSAR
   ‚Üì
üîµ REFACTOR: Melhorar sem quebrar testes
   ‚Üì
üîÅ REPETIR para cada comportamento
```

### Domain-Driven Design (DDD)
- **Bounded Contexts**: Identity, Stations, Prices, Recommendations
- **Aggregates**: User, Station, PriceSurvey, UserPreference
- **Value Objects**: Email, Cnpj, Coordinates, Price, Password, RefreshToken
- **Domain Events**: UserRegisteredEvent, StationCreatedEvent, PriceUpdatedEvent
- **Domain Exceptions**: Custom exceptions para regras de neg√≥cio

### Princ√≠pios SOLID
- **Single Responsibility**: Cada classe tem uma √∫nica responsabilidade
- **Open/Closed**: Extens√≠vel, mas fechado para modifica√ß√£o
- **Liskov Substitution**: Substitui√ß√£o sem quebrar comportamento
- **Interface Segregation**: Interfaces espec√≠ficas e coesas
- **Dependency Inversion**: Depender de abstra√ß√µes

---

## üõ†Ô∏è STACK TECNOL√ìGICA (Vers√µes LTS - OBRIGAT√ìRIO)

### Backend (.NET)
| Tecnologia | Vers√£o EXATA | Status |
|------------|--------------|--------|
| .NET SDK | **8.0.404** | LTS at√© nov/2026 |
| C# | **12.0** | Inclu√≠do no .NET 8 |
| ASP.NET Core | **8.0.11** | Runtime LTS |

### Pacotes NuGet (VERS√ïES FIXAS)
```xml
<!-- Domain Layer (Fase 01) -->
<PackageReference Include="FluentValidation" Version="11.10.0" />

<!-- Tests (Fase 01 - TDD) -->
<PackageReference Include="xunit" Version="2.9.2" />
<PackageReference Include="xunit.runner.visualstudio" Version="2.8.2" />
<PackageReference Include="FluentAssertions" Version="6.12.2" />
<PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.11.1" />

<!-- Application Layer (Fase 02 - FUTURO) -->
<PackageReference Include="MediatR" Version="12.4.1" />
<PackageReference Include="Moq" Version="4.20.72" />

<!-- Infrastructure Layer (Fase 03 - FUTURO) -->
<PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.11" />
<PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
<PackageReference Include="MongoDB.Driver" Version="2.29.0" />

<!-- API Layer (Fase 04 - FUTURO) -->
<PackageReference Include="Grpc.AspNetCore" Version="2.66.0" />
<PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="8.0.11" />
<PackageReference Include="Swashbuckle.AspNetCore" Version="6.9.0" />
<PackageReference Include="Serilog.AspNetCore" Version="8.0.3" />
```

### Bancos de Dados (FUTURO - Fase 03)
| Tecnologia | Vers√£o | Servi√ßos |
|------------|--------|----------|
| PostgreSQL | 16.6 | Identity, Stations |
| MongoDB | 7.0.15 | Prices, Recommendations |

---

## üìÅ ESTRUTURA DO PROJETO (Fase 01 - Domain + Tests)

```
PostoCerto/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md              # Documenta√ß√£o completa
‚îÇ   ‚îî‚îÄ‚îÄ .copilot-memory.md           # ESTE ARQUIVO
‚îÇ
‚îú‚îÄ‚îÄ libs/
‚îÇ   ‚îî‚îÄ‚îÄ building-blocks/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ BuildingBlocks.Domain/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Entity.cs         # Classe base para entidades
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ValueObject.cs    # Classe base para value objects
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ Result.cs         # Pattern para retornos
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ DomainEvent.cs    # Base para eventos
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îÇ           ‚îî‚îÄ‚îÄ BuildingBlocks.Domain.Tests/
‚îÇ               ‚îú‚îÄ‚îÄ EntityTests.cs
‚îÇ               ‚îú‚îÄ‚îÄ ValueObjectTests.cs
‚îÇ               ‚îî‚îÄ‚îÄ ResultTests.cs
‚îÇ
‚îî‚îÄ‚îÄ services/
    ‚îú‚îÄ‚îÄ identity-service/
    ‚îÇ   ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Identity.Domain/
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Entities/         # User, Role
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ValueObjects/     # Email, Password, RefreshToken
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Events/           # UserRegisteredEvent
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Exceptions/       # InvalidEmailException
    ‚îÇ   ‚îî‚îÄ‚îÄ tests/
    ‚îÇ       ‚îî‚îÄ‚îÄ Identity.Domain.Tests/
    ‚îÇ           ‚îú‚îÄ‚îÄ ValueObjects/
    ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ EmailTests.cs
    ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ PasswordTests.cs
    ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ RefreshTokenTests.cs
    ‚îÇ           ‚îî‚îÄ‚îÄ Entities/
    ‚îÇ               ‚îú‚îÄ‚îÄ UserTests.cs
    ‚îÇ               ‚îî‚îÄ‚îÄ RoleTests.cs
    ‚îÇ
    ‚îú‚îÄ‚îÄ stations-service/
    ‚îÇ   ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Stations.Domain/
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Entities/         # Station
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ValueObjects/     # Cnpj, Coordinates, Address
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Services/         # GeoSearchService (domain service)
    ‚îÇ   ‚îî‚îÄ‚îÄ tests/
    ‚îÇ       ‚îî‚îÄ‚îÄ Stations.Domain.Tests/
    ‚îÇ           ‚îú‚îÄ‚îÄ ValueObjects/
    ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ CnpjTests.cs
    ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ CoordinatesTests.cs
    ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ AddressTests.cs
    ‚îÇ           ‚îî‚îÄ‚îÄ Entities/
    ‚îÇ               ‚îî‚îÄ‚îÄ StationTests.cs
    ‚îÇ
    ‚îú‚îÄ‚îÄ prices-service/
    ‚îÇ   ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Prices.Domain/
    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Entities/         # PriceSurvey, FuelPrice
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ValueObjects/     # FuelType, Price, SurveyDate
    ‚îÇ   ‚îî‚îÄ‚îÄ tests/
    ‚îÇ       ‚îî‚îÄ‚îÄ Prices.Domain.Tests/
    ‚îÇ           ‚îú‚îÄ‚îÄ ValueObjects/
    ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ FuelTypeTests.cs
    ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ PriceTests.cs
    ‚îÇ           ‚îî‚îÄ‚îÄ Entities/
    ‚îÇ               ‚îî‚îÄ‚îÄ PriceSurveyTests.cs
    ‚îÇ
    ‚îî‚îÄ‚îÄ recommendations-service/
        ‚îú‚îÄ‚îÄ src/
        ‚îÇ   ‚îî‚îÄ‚îÄ Recommendations.Domain/
        ‚îÇ       ‚îú‚îÄ‚îÄ Entities/         # UserPreference, Recommendation
        ‚îÇ       ‚îî‚îÄ‚îÄ ValueObjects/     # PreferredFuelType
        ‚îî‚îÄ‚îÄ tests/
            ‚îî‚îÄ‚îÄ Recommendations.Domain.Tests/
                ‚îî‚îÄ‚îÄ Entities/
                    ‚îî‚îÄ‚îÄ UserPreferenceTests.cs
```

---

## üìã CONVEN√á√ïES E PADR√ïES

### Nomenclatura de C√≥digo
- **Entidades**: PascalCase, substantivos singulares (User, Station, PriceSurvey)
- **Value Objects**: PascalCase, substantivos (Email, Coordinates, Price)
- **Eventos**: PascalCase, passado + "Event" (UserRegisteredEvent)
- **Exce√ß√µes**: PascalCase, sufixo "Exception" (InvalidEmailException)

### Nomenclatura de Testes (TDD)
- **Classe de teste**: `{ClasseTestada}Tests.cs` (EmailTests.cs)
- **M√©todo de teste**: `{M√©todo}_Should_{Comportamento}_When_{Condi√ß√£o}`
  - Exemplo: `Create_Should_ThrowException_When_EmailIsInvalid`
  - Exemplo: `Create_Should_ReturnValidEmail_When_EmailIsValid`
- **Padr√£o AAA**: Arrange ‚Üí Act ‚Üí Assert (coment√°rios obrigat√≥rios)

### Organiza√ß√£o de C√≥digo
- **Namespace Domain**: `PostoCerto.{Service}.Domain.{Tipo}` 
  - Exemplo: `PostoCerto.Identity.Domain.Entities`
- **Namespace Tests**: `PostoCerto.{Service}.Domain.Tests.{Tipo}`
  - Exemplo: `PostoCerto.Identity.Domain.Tests.ValueObjects`
- **Um arquivo por classe/teste**
- **Propriedades privadas com backing fields quando necess√°rio**
- **M√©todos de f√°brica est√°ticos** para cria√ß√£o de entidades: `Create()`, `CreateFrom()`

### Domain Layer (Fase 01 - TDD)

#### üî¥ RED: Escrever Teste Primeiro
```csharp
// tests/Identity.Domain.Tests/ValueObjects/EmailTests.cs
using FluentAssertions;
using PostoCerto.Identity.Domain.ValueObjects;
using PostoCerto.Identity.Domain.Exceptions;
using Xunit;

namespace PostoCerto.Identity.Domain.Tests.ValueObjects;

public class EmailTests
{
    [Fact]
    public void Create_Should_ReturnValidEmail_When_EmailIsValid()
    {
        // Arrange
        var emailString = "user@example.com";
        
        // Act
        var email = Email.Create(emailString);
        
        // Assert
        email.Value.Should().Be("user@example.com");
    }
    
    [Fact]
    public void Create_Should_ThrowException_When_EmailIsInvalid()
    {
        // Arrange
        var invalidEmail = "invalid-email";
        
        // Act
        Action act = () => Email.Create(invalidEmail);
        
        // Assert
        act.Should().Throw<InvalidEmailException>()
           .WithMessage("*inv√°lido*");
    }
}
```

#### üü¢ GREEN: Implementar C√≥digo para Passar no Teste
```csharp
// src/Identity.Domain/ValueObjects/Email.cs
public class Email : ValueObject
{
    public string Value { get; }
    
    private Email(string value)
    {
        Value = value;
    }
    
    public static Email Create(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            throw new InvalidEmailException("Email n√£o pode ser vazio");
            
        if (!email.Contains("@"))
            throw new InvalidEmailException("Email inv√°lido");
            
        return new Email(email.ToLowerInvariant());
    }
    
    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return Value;
    }
}
```

#### üîµ REFACTOR: Melhorar sem quebrar testes
```csharp
// Adicionar regex para valida√ß√£o mais robusta
private static readonly Regex EmailRegex = new(@"^[^@\s]+@[^@\s]+\.[^@\s]+$");

public static Email Create(string email)
{
    if (string.IsNullOrWhiteSpace(email))
        throw new InvalidEmailException("Email n√£o pode ser vazio");
        
    if (!EmailRegex.IsMatch(email))
        throw new InvalidEmailException("Email inv√°lido");
        
    return new Email(email.ToLowerInvariant());
}
```

---

## üö´ REGRAS DE PROIBI√á√ÉO

### ‚ùå N√ÉO fazer na Fase 01:
- Criar camadas Application, Infrastructure ou API
- Adicionar Entity Framework, MediatR ou bibliotecas de infraestrutura
- Implementar reposit√≥rios ou interfaces de persist√™ncia
- Adicionar controllers, endpoints ou gRPC
- Configurar banco de dados, Docker ou docker-compose
- Implementar frontend (React/Flutter)
- Adicionar logging, valida√ß√£o ou behaviors

### ‚úÖ FAZER na Fase 01:
- **Criar testes ANTES** do c√≥digo de produ√ß√£o (TDD)
- Criar apenas classes de dom√≠nio puro (Entities, Value Objects, Events, Exceptions)
- Implementar regras de neg√≥cio dentro das entidades
- Usar BuildingBlocks.Domain como base
- Validar regras de neg√≥cio nos m√©todos de cria√ß√£o/factory
- Garantir imutabilidade em Value Objects
- Manter entidades ricas (n√£o an√™micas)
- Usar FluentAssertions para assertions leg√≠veis
- Seguir padr√£o AAA (Arrange-Act-Assert) nos testes

---

## üéØ COMANDOS PERMITIDOS (Fase 01 - TDD)

### Criar Solution/Projetos Domain + Tests
```bash
# Criar solution para um servi√ßo
dotnet new sln -n IdentityService

# Criar projeto Domain (classlib)
dotnet new classlib -n Identity.Domain -o src/Identity.Domain --framework net8.0

# Criar projeto Tests (xunit)
dotnet new xunit -n Identity.Domain.Tests -o tests/Identity.Domain.Tests --framework net8.0

# Adicionar projetos √† solution
dotnet sln add src/Identity.Domain/Identity.Domain.csproj
dotnet sln add tests/Identity.Domain.Tests/Identity.Domain.Tests.csproj

# Adicionar refer√™ncia do Domain no Tests
dotnet add tests/Identity.Domain.Tests reference src/Identity.Domain
```

### Adicionar Refer√™ncias e Pacotes
```bash
# Adicionar refer√™ncia ao BuildingBlocks no Domain
dotnet add src/Identity.Domain reference ../../../libs/building-blocks/src/BuildingBlocks.Domain

# Adicionar FluentValidation (se necess√°rio no domain)
dotnet add src/Identity.Domain package FluentValidation --version 11.10.0

# Adicionar FluentAssertions no Tests
dotnet add tests/Identity.Domain.Tests package FluentAssertions --version 6.12.2
```

### Build e Execu√ß√£o de Testes
```bash
# Build de um servi√ßo
dotnet build services/identity-service/IdentityService.sln

# Executar testes de um servi√ßo
dotnet test services/identity-service/IdentityService.sln

# Executar testes com verbosidade
dotnet test services/identity-service/IdentityService.sln --verbosity normal

# Build de todos os servi√ßos
dotnet build

# Executar todos os testes
dotnet test
```

---

## üìö DOM√çNIOS DE NEG√ìCIO

### Identity Service
- **Agregado**: User
- **VOs**: Email, Password, RefreshToken
- **Regras**: 
  - Email deve ser √∫nico e v√°lido
  - Password deve ter m√≠nimo 8 caracteres
  - RefreshToken expira em 7 dias

### Stations Service
- **Agregado**: Station
- **VOs**: Cnpj, Coordinates, Address
- **Regras**: 
  - CNPJ deve ser v√°lido (14 d√≠gitos)
  - Coordenadas devem estar no Brasil
  - Endere√ßo completo obrigat√≥rio

### Prices Service
- **Agregado**: PriceSurvey
- **Entidades**: FuelPrice (parte do agregado)
- **VOs**: FuelType, Price, SurveyDate
- **Regras**: 
  - Pre√ßo sempre positivo
  - FuelType deve ser v√°lido (Gasolina, Etanol, Diesel, GNV)
  - Data da pesquisa n√£o pode ser futura

### Recommendations Service
- **Agregado**: UserPreference
- **Entidades**: Recommendation
- **VOs**: PreferredFuelType
- **Regras**: 
  - Prefer√™ncias por usu√°rio
  - Raio m√°ximo de busca: 50km

---

## üí° ANTES DE RESPONDER QUALQUER PERGUNTA

1. ‚úÖ Consultar FASE ATUAL (Fase 01 - Domain Layer + Tests com TDD)
2. ‚úÖ Verificar se a sugest√£o est√° dentro do escopo da fase
3. ‚úÖ Confirmar vers√µes exatas da stack tecnol√≥gica
4. ‚úÖ Validar contra princ√≠pios de Clean Architecture, DDD e TDD
5. ‚úÖ Garantir que segue conven√ß√µes de nomenclatura
6. ‚úÖ Lembrar de criar TESTES PRIMEIRO (Red-Green-Refactor)
7. ‚ùå Recusar sugest√µes fora do escopo da Fase 01

---

**√öltima atualiza√ß√£o**: 29/12/2025  
**Fase**: 01 - Domain Layer + Tests (TDD)  
**Status**: Em desenvolvimento - BuildingBlocks em andamento
